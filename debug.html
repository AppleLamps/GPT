<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>API Key Debugging Tool</h1>

    <div class="section">
        <h2>Authentication Status</h2>
        <div id="auth-status">Checking...</div>
        <button id="check-auth">Check Auth Status</button>
        <button id="sign-out">Sign Out</button>
    </div>

    <div class="section">
        <h2>API Keys</h2>
        <div id="api-keys">Not loaded yet</div>
        <button id="load-api-keys">Load API Keys</button>
    </div>

    <div class="section">
        <h2>Direct Database Query</h2>
        <div id="direct-query-result">Not queried yet</div>
        <button id="direct-query">Run Direct Query</button>
    </div>

    <div class="section">
        <h2>User ID Check</h2>
        <div id="user-id-check-result">Not checked yet</div>
        <button id="check-user-id">Check User ID Match</button>
    </div>

    <div class="section">
        <h2>Fix Attempts</h2>
        <div id="fix-result">No fixes attempted</div>
        <button id="attempt-fix">Attempt API Key Fix</button>
        <button id="force-reload-settings">Force Reload Settings</button>

        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
            <h3>Fix User ID Mismatch</h3>
            <p>If you have a user ID mismatch, enter the old user ID to update:</p>
            <input type="text" id="old-user-id" placeholder="Old User ID" style="width: 300px; padding: 5px;">
            <button id="fix-user-id">Fix User ID</button>
        </div>
    </div>

    <div class="section">
        <h2>Debug Log</h2>
        <pre id="debug-log" class="log"></pre>
        <button id="clear-log">Clear Log</button>
    </div>

    <!-- Include Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Include your app's scripts -->
    <script src="js/supabaseClient.js"></script>
    <script src="js/authService.js"></script>
    <script src="js/state.js"></script>
    <script src="js/dataService.js"></script>
    <script src="js/notificationHelper.js"></script>
    <script src="js/debugHelper.js" type="module"></script>
    <script src="js/userIdCheck.js" type="module"></script>

    <script>
        // Debug logging function
        function log(message) {
            const logElement = document.getElementById('debug-log');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        // Clear log
        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('debug-log').innerHTML = '';
        });

        // Check authentication status
        async function checkAuthStatus() {
            try {
                log('Checking authentication status...');

                // Make sure supabase is defined
                if (typeof supabase === 'undefined' || !supabase) {
                    throw new Error('Supabase client is not initialized');
                }

                // Check if auth is available
                if (!supabase.auth) {
                    throw new Error('Supabase auth is not available');
                }

                // Try to get the session
                const { data, error } = await supabase.auth.getSession();

                if (error) {
                    throw error;
                }

                const session = data?.session;
                const user = session?.user;

                const authStatusElement = document.getElementById('auth-status');
                if (user) {
                    authStatusElement.innerHTML = `
                        <p>✅ Authenticated</p>
                        <p><strong>User ID:</strong> ${user.id}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                    `;
                    log(`Authenticated as ${user.email} (${user.id})`);
                } else {
                    authStatusElement.innerHTML = '❌ Not authenticated';
                    log('Not authenticated');
                }

                return user;
            } catch (error) {
                log(`Error checking auth status: ${error.message}`);
                document.getElementById('auth-status').innerHTML = `❌ Error: ${error.message}`;
                return null;
            }
        }

        // Load API keys
        async function loadApiKeys() {
            try {
                log('Loading API keys...');
                const user = await checkAuthStatus();

                if (!user) {
                    log('Cannot load API keys: Not authenticated');
                    document.getElementById('api-keys').innerHTML = '❌ Not authenticated';
                    return;
                }

                // Try using dataService
                log('Attempting to load API keys using dataService...');
                const apiKeys = await dataService.getApiKeys();
                log(`dataService returned ${apiKeys.length} API keys`);

                // Direct query as a backup
                log('Attempting direct query to api_keys table...');
                const { data, error } = await supabase
                    .from('api_keys')
                    .select('provider, encrypted_key')
                    .eq('user_id', user.id);

                if (error) {
                    log(`Direct query error: ${error.message}`);
                    throw error;
                }

                log(`Direct query returned ${data?.length || 0} API keys`);

                // Display results
                const apiKeysElement = document.getElementById('api-keys');
                if (apiKeys.length > 0) {
                    apiKeysElement.innerHTML = '<h3>API Keys from dataService:</h3>';
                    apiKeysElement.innerHTML += '<ul>';
                    apiKeys.forEach(key => {
                        apiKeysElement.innerHTML += `<li><strong>${key.provider}:</strong> ${maskApiKey(key.encrypted_key)}</li>`;
                    });
                    apiKeysElement.innerHTML += '</ul>';
                } else {
                    apiKeysElement.innerHTML = '❌ No API keys found via dataService';
                }

                if (data && data.length > 0) {
                    apiKeysElement.innerHTML += '<h3>API Keys from direct query:</h3>';
                    apiKeysElement.innerHTML += '<ul>';
                    data.forEach(key => {
                        apiKeysElement.innerHTML += `<li><strong>${key.provider}:</strong> ${maskApiKey(key.encrypted_key)}</li>`;
                    });
                    apiKeysElement.innerHTML += '</ul>';
                } else {
                    apiKeysElement.innerHTML += '<p>❌ No API keys found via direct query</p>';
                }
            } catch (error) {
                log(`Error loading API keys: ${error.message}`);
                document.getElementById('api-keys').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Run direct query
        async function runDirectQuery() {
            try {
                log('Running direct query...');
                const user = await checkAuthStatus();

                if (!user) {
                    log('Cannot run query: Not authenticated');
                    document.getElementById('direct-query-result').innerHTML = '❌ Not authenticated';
                    return;
                }

                // Check RLS policies
                log('Checking RLS policies...');
                const { data: rlsData, error: rlsError } = await supabase
                    .rpc('check_rls_policies', { table_name: 'api_keys' });

                if (rlsError) {
                    log(`RLS check error: ${rlsError.message}`);
                } else {
                    log(`RLS check result: ${JSON.stringify(rlsData)}`);
                }

                // Query the api_keys table
                log(`Querying api_keys for user_id: ${user.id}`);
                const { data, error } = await supabase
                    .from('api_keys')
                    .select('*')
                    .eq('user_id', user.id);

                if (error) {
                    log(`Query error: ${error.message}`);
                    throw error;
                }

                log(`Query returned ${data?.length || 0} rows`);

                // Display results
                const resultElement = document.getElementById('direct-query-result');
                if (data && data.length > 0) {
                    resultElement.innerHTML = `<p>Found ${data.length} API keys:</p>`;
                    resultElement.innerHTML += '<pre>' + JSON.stringify(data.map(key => ({
                        ...key,
                        encrypted_key: maskApiKey(key.encrypted_key)
                    })), null, 2) + '</pre>';
                } else {
                    resultElement.innerHTML = '❌ No API keys found';
                }
            } catch (error) {
                log(`Error in direct query: ${error.message}`);
                document.getElementById('direct-query-result').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Mask API key for display
        function maskApiKey(key) {
            if (!key) return 'null';
            if (key.length <= 8) return '****';
            return key.substring(0, 4) + '...' + key.substring(key.length - 4);
        }

        // Sign out
        document.getElementById('sign-out').addEventListener('click', async () => {
            try {
                log('Signing out...');
                await supabase.auth.signOut();
                log('Signed out successfully');
                checkAuthStatus();
            } catch (error) {
                log(`Error signing out: ${error.message}`);
            }
        });

        // Check user ID match
        async function checkUserIdMatch() {
            try {
                log('Checking user ID match...');

                // Import the userIdCheck module
                const userIdCheckModule = await import('./js/userIdCheck.js');
                const results = await userIdCheckModule.checkUserIdMatch();

                log(`User ID check results: ${JSON.stringify(results)}`);

                const resultElement = document.getElementById('user-id-check-result');
                if (results.authenticated) {
                    resultElement.innerHTML = `
                        <p>Authentication Status: ✅ Authenticated</p>
                        <p>Auth User ID: ${results.authUserId}</p>
                        <p>API Keys Found: ${results.apiKeysFound ? '✅ Yes' : '❌ No'}</p>
                        ${results.apiKeysFound ? `<p>API Keys User ID: ${results.apiKeysUserId}</p>` : ''}
                        ${results.apiKeysFound ? `<p>User ID Match: ${results.match ? '✅ Match' : '❌ Mismatch'}</p>` : ''}
                    `;

                    if (results.apiKeysFound && !results.match) {
                        resultElement.innerHTML += `
                            <p style="color: red; font-weight: bold;">WARNING: User ID mismatch detected!</p>
                            <p>This means the API keys in the database belong to a different user than the one currently authenticated.</p>
                        `;
                    }
                } else {
                    resultElement.innerHTML = '❌ Not authenticated';
                }

                // Also check API keys access
                const accessResults = await userIdCheckModule.checkApiKeysAccess();
                log(`API keys access check results: ${JSON.stringify(accessResults)}`);

                if (results.authenticated) {
                    resultElement.innerHTML += `
                        <h3>API Keys Table Access:</h3>
                        <p>SELECT: ${accessResults.canSelect ? '✅ Yes' : '❌ No'}</p>
                        <p>INSERT: ${accessResults.canInsert ? '✅ Yes' : '❌ No'}</p>
                    `;
                }
            } catch (error) {
                log(`Error checking user ID match: ${error.message}`);
                document.getElementById('user-id-check-result').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Attempt API key fix
        async function attemptApiKeyFix() {
            try {
                log('Attempting API key fix...');

                // Import the debugHelper module
                const debugHelperModule = await import('./js/debugHelper.js');
                const results = await debugHelperModule.attemptApiKeyFix();

                log(`Fix attempt results: ${JSON.stringify(results)}`);

                const resultElement = document.getElementById('fix-result');
                if (results.success) {
                    resultElement.innerHTML = `
                        <p>✅ Fix successful!</p>
                        <p>Message: ${results.message}</p>
                        <p>API Keys: ${results.keys ? results.keys.map(k => k.provider).join(', ') : 'None'}</p>
                    `;
                } else {
                    resultElement.innerHTML = `
                        <p>❌ Fix failed</p>
                        <p>Message: ${results.message}</p>
                        <pre>${results.debugResults ? JSON.stringify(results.debugResults, null, 2) : ''}</pre>
                    `;
                }
            } catch (error) {
                log(`Error attempting fix: ${error.message}`);
                document.getElementById('fix-result').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Force reload settings
        async function forceReloadSettings() {
            try {
                log('Forcing settings reload...');

                // Import the state module
                const stateModule = await import('./js/state.js');
                await stateModule.loadSettings();

                log('Settings reloaded');

                // Check if API keys are now loaded
                const debugHelperModule = await import('./js/debugHelper.js');
                const results = await debugHelperModule.debugApiKeyIssues();

                log(`Settings reload results: ${JSON.stringify(results)}`);

                const resultElement = document.getElementById('fix-result');
                if (results.apiKeysFromService && results.apiKeysFromService.length > 0) {
                    resultElement.innerHTML = `
                        <p>✅ Settings reload successful!</p>
                        <p>API Keys: ${results.apiKeysFromService.map(k => k.provider).join(', ')}</p>
                    `;
                } else {
                    resultElement.innerHTML = `
                        <p>❌ Settings reload did not fix the issue</p>
                        <p>API Keys still not loading</p>
                        <pre>${JSON.stringify(results, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                log(`Error reloading settings: ${error.message}`);
                document.getElementById('fix-result').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Fix user ID mismatch
        async function fixUserIdMismatch() {
            try {
                const oldUserId = document.getElementById('old-user-id').value.trim();
                if (!oldUserId) {
                    alert('Please enter the old user ID');
                    return;
                }

                log(`Attempting to fix user ID mismatch. Old ID: ${oldUserId}`);

                // Import the fixApiKeys module
                const fixApiKeysModule = await import('./js/fixApiKeys.js');
                const results = await fixApiKeysModule.fixApiKeyUserId(oldUserId);

                log(`Fix user ID results: ${JSON.stringify(results)}`);

                const resultElement = document.getElementById('fix-result');
                if (results.success) {
                    resultElement.innerHTML = `
                        <p>✅ User ID fix successful!</p>
                        <p>Message: ${results.message}</p>
                        <p>Keys Updated: ${results.keysUpdated}</p>
                    `;

                    // Force reload settings to apply the fix
                    await forceReloadSettings();
                } else {
                    resultElement.innerHTML = `
                        <p>❌ User ID fix failed</p>
                        <p>Message: ${results.message}</p>
                        ${results.error ? `<p>Error: ${results.error}</p>` : ''}
                    `;
                }
            } catch (error) {
                log(`Error fixing user ID: ${error.message}`);
                document.getElementById('fix-result').innerHTML = `❌ Error: ${error.message}`;
            }
        }

        // Event listeners
        document.getElementById('check-auth').addEventListener('click', checkAuthStatus);
        document.getElementById('load-api-keys').addEventListener('click', loadApiKeys);
        document.getElementById('direct-query').addEventListener('click', runDirectQuery);
        document.getElementById('check-user-id').addEventListener('click', checkUserIdMatch);
        document.getElementById('attempt-fix').addEventListener('click', attemptApiKeyFix);
        document.getElementById('force-reload-settings').addEventListener('click', forceReloadSettings);
        document.getElementById('fix-user-id').addEventListener('click', fixUserIdMismatch);

        // Initialize Supabase client manually if needed
        async function initializeSupabase() {
            try {
                log('Initializing Supabase client...');

                // Check if supabase is already defined
                if (typeof supabase !== 'undefined' && supabase) {
                    log('Supabase client already initialized');
                    return true;
                }

                // Check if the supabase-js script is loaded
                if (typeof window.supabase === 'undefined') {
                    log('Supabase JS library not found, attempting to load it...');

                    // Try to load the script dynamically
                    return new Promise((resolve) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                        script.onload = () => {
                            log('Supabase JS library loaded');

                            // Initialize the client
                            const supabaseUrl = 'https://keuxuonslkcvdeysdoge.supabase.co';
                            const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtldXh1b25zbGtjdmRleXNkb2dlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNjc5MjUsImV4cCI6MjA2MDg0MzkyNX0.C1Bkoo9A3BlbfkHlUj7UdCmOPonMFftEFTOTHVQWIl4';

                            window.supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                            log('Supabase client initialized');

                            resolve(true);
                        };
                        script.onerror = () => {
                            log('Failed to load Supabase JS library');
                            resolve(false);
                        };
                        document.head.appendChild(script);
                    });
                }

                return false;
            } catch (error) {
                log(`Error initializing Supabase: ${error.message}`);
                return false;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            log('Debug page loaded');

            // Make sure Supabase is initialized
            const initialized = await initializeSupabase();
            log(`Supabase initialization ${initialized ? 'successful' : 'failed'}`);

            // Try to check auth status
            await checkAuthStatus();
        });
    </script>
</body>
</html>
